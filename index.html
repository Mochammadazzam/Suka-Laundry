<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suka Laundry Pro</title>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        #status { margin-top: 20px; padding: 10px; background: #222; color: #0f0; font-family: monospace; font-size: 11px; text-align: left; border-radius: 5px; min-height: 150px; white-space: pre-wrap; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="card">
        <h2>SUKA LAUNDRY PRINTER</h2>
        <button class="btn-blue" onclick="runBluetooth()">1. SCAN & HUBUNGKAN</button>
        <button id="btnPrint" class="btn-green" onclick="printStruk()" disabled>2. CETAK STRUK</button>
        <div id="status">Status: Siap...</div>
    </div>

    <script>
    window.selectedDeviceId = null; 

    function log(msg) {
        const status = document.getElementById('status');
        status.innerText += "\n> " + msg;
        status.scrollTop = status.scrollHeight;
    }

    async function runBluetooth() {
        const BleClient = window.Capacitor.Plugins.BluetoothLe;
        try {
            log("Inisialisasi...");
            await BleClient.initialize({ androidNeverForLocation: true });
            
            log("Mencari Printer...");
            const device = await BleClient.requestDevice({ acceptAllDevices: true });
            
            if (device && device.deviceId) {
                window.selectedDeviceId = device.deviceId; 
                log("TERHUBUNG: " + (device.name || "EPPOS"));
                document.getElementById('btnPrint').disabled = false;
            }
        } catch (err) { log("ERR: " + err.message); }
    }

    async function printStruk() {
        const BleClient = window.Capacitor.Plugins.BluetoothLe;
        const currentId = window.selectedDeviceId;

        try {
            log("Menghubungkan...");
            await BleClient.connect({ deviceId: currentId });

            const result = await BleClient.getServices({ deviceId: currentId });
            const services = result.services || [];
            
            let s_uuid = "000018f0-0000-1000-8000-00805f9b34fb";
            let c_uuid = "00002af1-0000-1000-8000-00805f9b34fb";
            let found = false;

            for (const s of services) {
                for (const c of s.characteristics) {
                    if (c.properties.writeWithoutResponse || c.properties.write) {
                        s_uuid = s.uuid; c_uuid = c.uuid; found = true; break;
                    }
                }
                if (found) break;
            }

            const encoder = new TextEncoder();
            const esc = "\x1B";
            let text = esc + "@" + esc + "a" + "\x01" + esc + "E" + "\x01" + "SUKA LAUNDRY\n" + esc + "E" + "\x00"; 
            text += "--------------------------------\n";
            text += "STATUS : BERHASIL\n";
            text += "--------------------------------\n\n\n\n\n"; 

            const uint8 = encoder.encode(text);
            log("Mengirim data...");

            // METODE PALING AMAN: Gunakan DataView langsung
            await BleClient.writeWithoutResponse({
                deviceId: currentId,
                service: s_uuid,
                characteristic: c_uuid,
                value: new DataView(uint8.buffer)
            });

            log("CETAK SELESAI!");
            
            setTimeout(async () => {
                await BleClient.disconnect({ deviceId: currentId });
                log("Koneksi ditutup.");
            }, 3000);

        } catch (err) {
            log("GAGAL: " + err.message);
            try { await BleClient.disconnect({ deviceId: currentId }); } catch(e) {}
        }
    }
    </script>
</body>
</html>
