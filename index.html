<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPPOS Pro Tester</title>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        .btn-green:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin-top: 20px; padding: 10px; background: #222; color: #0f0; font-family: monospace; font-size: 11px; text-align: left; border-radius: 5px; min-height: 120px; white-space: pre-wrap; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="card">
        <h2>EPPOS Printer Tester</h2>
        <button class="btn-blue" onclick="runBluetooth()">1. AKTIFKAN & SCAN PRINTER</button>
        <button id="btnPrint" class="btn-green" onclick="printStruk()" disabled>2. CETAK STRUK TES</button>
        <div id="status">Status: Menunggu Klik...</div>
    </div>

    <script>
    // Gunakan window agar variabel menempel permanen di session browser
    window.selectedDeviceId = null; 

    function log(msg) {
        const status = document.getElementById('status');
        status.innerText += "\n> " + msg;
        status.scrollTop = status.scrollHeight;
    }

    function getBleClient() {
        if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.BluetoothLe) {
            return window.Capacitor.Plugins.BluetoothLe;
        }
        return null;
    }

    async function runBluetooth() {
        const BleClient = getBleClient();
        if (!BleClient) { log("ERROR: Plugin tidak ada."); return; }

        try {
            await BleClient.initialize();
            log("Inisialisasi...");

            const isEnabled = await BleClient.isEnabled();
            if (!isEnabled) {
                log("Bluetooth mati. Mengaktifkan...");
                await BleClient.requestEnable();
            }

            log("Mencari perangkat...");
            const device = await BleClient.requestDevice({ acceptAllDevices: true });
            
            if (device && device.deviceId) {
                // SIMPAN KE WINDOW VARIABLE
                window.selectedDeviceId = device.deviceId; 
                log("TERHUBUNG KE: " + (device.name || "Printer"));
                log("ID DISIMPAN: " + window.selectedDeviceId);
                
                document.getElementById('btnPrint').disabled = false;
                alert("Printer Terhubung!");
            }
        } catch (err) {
            log("ERROR: " + err.message);
        }
    }

        async function printStruk() {
        const BleClient = getBleClient();
        const currentId = window.selectedDeviceId;

        try {
            if (!currentId) {
                log("GAGAL: Scan printer dulu.");
                return;
            }

            log("Menghubungkan ke: " + currentId);
            await BleClient.connect({ deviceId: currentId });
            log("Handshake Berhasil!");

            log("Mencari jalur data...");
            const result = await BleClient.getServices({ deviceId: currentId });
            
            // Penanganan agar tidak error 'not iterable'
            const services = Array.isArray(result) ? result : (result.services || []);
            
            // Default UUID untuk EPPOS/RPP02
            let targetService = "000018f0-0000-1000-8000-00805f9b34fb"; 
            let targetChar = "00002af1-0000-1000-8000-00805f9b34fb";    
            let found = false;

            if (services.length > 0) {
                for (const s of services) {
                    for (const c of s.characteristics) {
                        if (c.properties.writeWithoutResponse || c.properties.write) {
                            targetService = s.uuid;
                            targetChar = c.uuid;
                            found = true;
                            break;
                        }
                    }
                    if (found) break;
                }
            }

            log("Menyiapkan teks...");
            const esc = "\x1B";
            let text = esc + "@"; // Reset printer
            text += esc + "a" + "\x01"; // Rata tengah
            text += esc + "E" + "\x01" + "SUKA LAUNDRY\n" + esc + "E" + "\x00"; // Bold aktif lalu mati
            text += "--------------------------------\n";
            text += "Tes Cetak : BERHASIL!\n";
            text += "Waktu     : " + new Date().toLocaleString('id-ID') + "\n";
            text += "--------------------------------\n";
            text += "\n\n\n\n"; // Spasi akhir (feed)

            // Proses konversi ke DataView (Solusi 'Value required')
            const hasilEncode = new TextEncoder().encode(text);
            const dataView = new DataView(hasilEncode.buffer);

            log("Mengirim teks ke printer...");

            // Menggunakan properti 'value' dengan DataView
            await BleClient.writeWithoutResponse({
                deviceId: currentId,
                service: targetService,
                characteristic: targetChar,
                value: dataView 
            });

            log("CETAK SELESAI!");

            // Beri waktu proses sebelum putus koneksi
            setTimeout(async () => {
                await BleClient.disconnect({ deviceId: currentId });
                log("Koneksi diputus aman.");
            }, 2000);

        } catch (err) {
            log("GAGAL: " + err.message);
            console.error("Detail Error:", err);
            if (currentId) {
                try { await BleClient.disconnect({ deviceId: currentId }); } catch(e) {}
            }
        }
    } 
</script>
</body>
</html>
