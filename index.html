<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>EPPOS Pro Suka Laundry</title>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        .btn-green:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin-top: 20px; padding: 10px; background: #222; color: #0f0; font-family: monospace; font-size: 11px; text-align: left; border-radius: 5px; min-height: 150px; white-space: pre-wrap; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="card">
        <h2>EPPOS Printer Tester</h2>
        <button class="btn-blue" onclick="runBluetooth()">1. AKTIFKAN & SCAN PRINTER</button>
        <button id="btnPrint" class="btn-green" onclick="printStruk()" disabled>2. CETAK STRUK TES</button>
        <div id="status">Status: Menunggu Klik...</div>
    </div>

    <script>
    window.selectedDeviceId = null; 

    function log(msg) {
        const status = document.getElementById('status');
        status.innerText += "\n> " + msg;
        status.scrollTop = status.scrollHeight;
    }

    function getBleClient() {
        return (window.Capacitor && window.Capacitor.Plugins) ? window.Capacitor.Plugins.BluetoothLe : null;
    }

    async function runBluetooth() {
        const BleClient = getBleClient();
        if (!BleClient) { log("ERROR: Plugin tidak terdeteksi."); return; }

        try {
            log("Inisialisasi sistem...");
            [span_6](start_span)[span_7](start_span)// Flag androidNeverForLocation sangat krusial untuk Android 12+[span_6](end_span)[span_7](end_span)
            await BleClient.initialize({ androidNeverForLocation: true });

            if (!(await BleClient.isEnabled())) {
                log("Mengaktifkan Bluetooth...");
                await BleClient.requestEnable();
            }

            log("Mencari perangkat...");
            const device = await BleClient.requestDevice({ acceptAllDevices: true });
            
            if (device && device.deviceId) {
                window.selectedDeviceId = device.deviceId; 
                log("TERHUBUNG: " + (device.name || "Printer"));
                document.getElementById('btnPrint').disabled = false;
                alert("Printer Siap!");
            }
        } catch (err) {
            log("ERROR INIT: " + err.message);
        }
    }

    async function printStruk() {
        const BleClient = getBleClient();
        const currentId = window.selectedDeviceId;

        try {
            if (!currentId) return log("Scan ulang printer!");

            log("Menyambungkan...");
            await BleClient.connect({ deviceId: currentId });
            log("Handshake Berhasil!");

            const result = await BleClient.getServices({ deviceId: currentId });
            const services = Array.isArray(result) ? result : (result.services || []);
            
            let targetService = "000018f0-0000-1000-8000-00805f9b34fb"; 
            let targetChar = "00002af1-0000-1000-8000-00805f9b34fb";    
            let found = false;

            for (const s of services) {
                for (const c of s.characteristics) {
                    if (c.properties.writeWithoutResponse || c.properties.write) {
                        targetService = s.uuid;
                        targetChar = c.uuid;
                        found = true;
                        break;
                    }
                }
                if (found) break;
            }

            log("Menyiapkan teks...");
            const encoder = new TextEncoder();
            const esc = "\x1B";
            let text = esc + "@" + esc + "a" + "\x01" + esc + "E" + "\x01" + "SUKA LAUNDRY\n" + esc + "E" + "\x00"; 
            text += "--------------------------------\n";
            text += "Tes Cetak : BERHASIL!\n";
            text += "Waktu     : " + new Date().toLocaleString('id-ID') + "\n";
            text += "--------------------------------\n\n\n\n"; 

            const uint8 = encoder.encode(text);
            log("Mengirim data...");

            [span_8](start_span)// Gunakan DataView langsung untuk menghindari 'Value required'[span_8](end_span)
            try {
                await BleClient.writeWithoutResponse({
                    deviceId: currentId,
                    service: targetService,
                    characteristic: targetChar,
                    value: new DataView(uint8.buffer)
                });
                log("CETAK SELESAI!");
            } catch (e) {
                log("Mencoba fallback...");
                const base64 = btoa(String.fromCharCode(...uint8));
                await BleClient.write({
                    deviceId: currentId,
                    service: targetService,
                    characteristic: targetChar,
                    value: base64
                });
                log("CETAK SELESAI (Alt)!");
            }

            setTimeout(async () => {
                await BleClient.disconnect({ deviceId: currentId });
                log("Koneksi diputus.");
            }, 1500);

        } catch (err) {
            log("GAGAL: " + err.message);
            try { await BleClient.disconnect({ deviceId: currentId }); } catch(e) {}
        }
    }
    </script>
</body>
</html>
